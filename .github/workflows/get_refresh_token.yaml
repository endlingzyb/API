name: Microsoft Graph API Demo

on:
  workflow_dispatch: # 手动触发
  schedule:
    - cron: "0 3 * * *" # 每天凌晨 3 点自动运行

jobs:
  call-graph-api:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: 安装依赖
        run: pip install msal requests

      - name: 获取 Access Token 并调用 Graph API
        env:
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          TENANT_ID: ${{ secrets.TENANT_ID }}
          MS_REFRESH_TOKEN: ${{ secrets.MS_REFRESH_TOKEN }}
        run: |
          import os, json, requests
          from msal import PublicClientApplication

          client_id = os.environ["CLIENT_ID"]
          tenant_id = os.environ.get("TENANT_ID", "common")
          refresh_token = os.environ["MS_REFRESH_TOKEN"]

          # 初始化 MSAL 应用
          app = PublicClientApplication(
              client_id=client_id,
              authority=f"https://login.microsoftonline.com/{tenant_id}"
          )

          # 用 refresh_token 获取新的 access_token
          scopes = ["User.Read", "Notes.ReadWrite", "offline_access"]
          result = app.acquire_token_by_refresh_token(refresh_token, scopes=scopes)

          if "access_token" not in result:
              print("❌ 获取 token 失败：", json.dumps(result, indent=2))
              exit(1)

          access_token = result["access_token"]
          print("✅ 成功获取 access_token")

          # 调用 Graph API 示例：获取用户信息
          resp = requests.get(
              "https://graph.microsoft.com/v1.0/me",
              headers={"Authorization": f"Bearer {access_token}"}
          )
          print("Graph API 响应：", resp.json())
